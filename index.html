<!doctype html>

<meta charset=utf-8>
<title>Stellar Navigator</title>
<link href=https://fonts.googleapis.com/css?family=Maven+Pro rel=stylesheet>
<link href=/bundle.css rel=stylesheet>
<body></body>
<script src=/elm.js></script>
<script>
var session = Math.random()
var testnet = false
if (location.pathname.slice(0, 9) === '/testnet/') {
  testnet = true
}

const app = Elm.Main.fullscreen({testnet: testnet})

app.ports.pushPage.subscribe(function ([testnet, pos, title, url]) {
  if (location.href.split('/').slice(3).join('/') == '#' + url) {
    return
  }

  url = (testnet ? '/testnet/#' : '/#') + url
  console.log('pushing', url)
  var state = {
    session: session,
    pos: pos
  }

  history.pushState(state, title, url)
})

if (location.hash.split('/').length > 2) {
  app.ports.navigate.send(location.hash.slice(1))

  history.replaceState({
    session: session,
    pos: 2
  }, document.title, (testnet ? '/testnet/' : '/') + location.hash)
}
  

window.onpopstate = function (e) {
  if (e.state === null || e.state.session !== session) {
    location.reload()
    return
  }

  var pos = e.state.pos
  console.log('will surf to', pos)
  app.ports.surf.send(pos)
}

// eventsource calls for the last operations and last ledgers
var sseops, ssetxns, sseleds

var lastScreens = [
  {eventsource: sseops, url: '/operations', port: 'newop'},
  {eventsource: ssetxns, url: '/transactions', port: 'newtxn'},
  {eventsource: sseleds, url: '/ledgers', port: 'newled'},
]

app.ports.sse.subscribe(function (base) {
  lastScreens.forEach(function (screen) {
    var url = screen.url
    var port = screen.port

    if (screen.eventsource) screen.eventsource.close()

    fetch(base + url + '?limit=15&order=desc')
      .then(function (r) { return r.json() })
      .then(function (data) {
        data._embedded.records.forEach(function (d) {
          app.ports[port].send(JSON.stringify(d))
        })

        screen.eventsource = new EventSource(base + url + '?cursor=now')
        screen.eventsource.onmessage = function (e) {
          app.ports[port].send(e.data)
        }
      })
  })
})
</script>

<script>;(function (d, s, c) {
  var x, h, n = Date.now()
  tc = function (p) {
    m = s.getItem('_tcx') > n ? s.getItem('_tch') : 'pochete-sopapo'
    x = new XMLHttpRequest()
    x.addEventListener('load', function () {
      if (x.status == 200) {
        s.setItem('_tch', x.responseText)
        s.setItem('_tcx', n + 14400000)
      }
    })
    x.open('GET', 'https://visitantes.alhur.es/'+m+'.xml?r='+d.referrer+'&c='+c+(p?'&p='+p:''))
    x.send()
  }
  tc()
})(document, localStorage, 'z6m0h6kl');</script>
