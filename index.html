<!doctype html>

<meta charset=utf-8>
<title>Stellar Navigator</title>
<link href=https://fonts.googleapis.com/css?family=Maven+Pro rel=stylesheet>
<link href=/bundle.css rel=stylesheet>
<body></body>
<script src=/elm.js></script>
<script>
var session = Math.random()
var testnet = false
if (location.pathname.slice(0, 9) === '/testnet/') {
  testnet = true
}

const app = Elm.Main.fullscreen({testnet: testnet})

app.ports.pushPage.subscribe(function ([testnet, pos, title, url]) {
  if (location.href.split('/').slice(3).join('/') == '#' + url) {
    return
  }

  url = (testnet ? '/testnet/#' : '/#') + url
  console.log('pushing', url)
  var state = {
    session: session,
    pos: pos
  }

  history.pushState(state, title, url)
})

if (location.hash.split('/').length > 2) {
  app.ports.navigate.send(location.hash.slice(1))

  history.replaceState({
    session: session,
    pos: 2
  }, document.title, (testnet ? '/testnet/' : '/') + location.hash)
}
  

window.onpopstate = function (e) {
  if (e.state === null || e.state.session !== session) {
    location.reload()
    return
  }

  var pos = e.state.pos
  console.log('will surf to', pos)
  app.ports.surf.send(pos)
}

// eventsource calls for the last operations and last ledgers
var sseops, ssetxns, sseleds
app.ports.sse.subscribe(function (base) {
  if (sseops) sseops.close()
  if (ssetxns) ssetxns.close()
  if (sseleds) sseleds.close()

  sseops = new EventSource(base + '/operations?cursor=now')
  sseops.onmessage = function (e) { app.ports.newop.send(e.data) }

  ssetxns = new EventSource(base + '/transactions?cursor=now')
  ssetxns.onmessage = function (e) { app.ports.newtxn.send(e.data) }

  sseleds = new EventSource(base + '/ledgers?cursor=now')
  sseleds.onmessage = function (e) { app.ports.newled.send(e.data) }
})
</script>
